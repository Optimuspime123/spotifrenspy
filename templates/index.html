<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Spotify Friend Activity</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- MDB -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.3.2/mdb.min.css" />
    <style>
        /* ===========================  
           Liquid Glass CSS – refined drop-in (less tacky, more elegant)  
           =========================== */  
        
        /* Tokens */  
        :root{  
          --spotify-green:#1DB954;  
          --spotify-black:#121212;  
          --spotify-dark:#181818;  
          --spotify-grey:#535353;  
          --spotify-light:#b3b3b3;  
        
          /* Liquid Glass knobs (tuned for subtlety) */  
          --lg-blur:8px;                 /* Balanced for perf & feel */  
          --lg-sat:140%;                 /* Softer saturation */  
          --lg-radius:16px;  
          --lg-shadow:0 8px 24px rgba(0,0,0,.12);  
          --lg-inner:inset 0 1px 0 rgba(255,255,255,.06);  
          --lg-press:scale(.98);  
          --lg-highlight:rgba(255,255,255,.08);  
          --lg-glow:rgba(29,185,84,.08);  
        }  
        
        /* Theme-aware material colors */  
        html[data-mdb-theme='dark']{  
          --lg-surface:rgba(18,18,18,.45);  
          --lg-surface-solid:#1a1a1a;  
          --lg-stroke:rgba(255,255,255,.08);  
          --lg-border1:rgba(255,255,255,.25);  
          --lg-border2:rgba(29,185,84,.18);  
          --lg-highlight:rgba(255,255,255,.10);  
          --lg-glow:rgba(29,185,84,.12);  
          --lg-text-muted:#b3b3b3;  
          /* Green arrows for accordions */
          --mdb-accordion-icon-color: var(--spotify-green);
          --mdb-accordion-icon-active-color: var(--spotify-green);
        }  
        html[data-mdb-theme='light']{  
          --lg-surface:rgba(255,255,255,.55);  
          --lg-surface-solid:#ffffff;  
          --lg-stroke:rgba(0,0,0,.05);  
          --lg-border1:rgba(255,255,255,.75);  
          --lg-border2:rgba(29,185,84,.22);  
          --lg-highlight:rgba(255,255,255,.18);  
          --lg-glow:rgba(29,185,84,.15);  
          --lg-text-muted:#616161;  
          /* Green arrows */
          --mdb-accordion-icon-color: var(--spotify-green);
          --mdb-accordion-icon-active-color: var(--spotify-green);
        }  
        
        /* Override MDB accordion arrows to green */
        .accordion-button::after {
          filter: brightness(0) saturate(100%) invert(54%) sepia(84%) saturate(2872%) hue-rotate(79deg) brightness(95%) contrast(101%);
        }
        .accordion-button:not(.collapsed)::after {
          filter: brightness(0) saturate(100%) invert(34%) sepia(93%) saturate(2872%) hue-rotate(79deg) brightness(95%) contrast(101%);
        }
        
        /* Background: subtle caustic vibes */  
        html,body{  
          height:100%;  
          background:  
            radial-gradient(1200px 700px at 8% -10%, rgba(29,185,84,.08), transparent 40%),  
            radial-gradient(900px 520px at 110% -20%, rgba(25,20,20,.15), transparent 50%),  
            conic-gradient(from 220deg at 80% 10%, rgba(255,255,255,.04), transparent 40%, rgba(255,255,255,.03));  
        }  
        body::before{  
          content:"";  
          position:fixed; inset:-20% -20% auto -20%; height:120%;  
          pointer-events:none; z-index:-1;  
          background:  
            conic-gradient(from 0deg at 50% 50%,  
              rgba(255,255,255,.03), transparent 18%,  
              rgba(255,255,255,.02) 35%, transparent 52%,  
              rgba(29,185,84,.04) 70%, transparent 88%, rgba(255,255,255,.02));  
          filter:blur(40px);  
          animation:lg-slow 60s linear infinite;  
        }  
        @media (prefers-reduced-motion:reduce){  
          body::before{animation:none}  
        }  
        @keyframes lg-slow{to{transform:rotate(360deg)}}  
        
        /* Utility: elegant glass surface */  
        .lg-surface{  
          position:relative;  
          isolation: isolate;  
          border:1px solid transparent;  
          background:  
            linear-gradient(180deg, var(--lg-surface), color-mix(in oklab, var(--lg-surface) 98%, transparent)) padding-box,  
            linear-gradient(135deg, var(--lg-border1), var(--lg-border2)) border-box;  
          -webkit-backdrop-filter: blur(var(--lg-blur)) saturate(var(--lg-sat));  
          backdrop-filter: blur(var(--lg-blur)) saturate(var(--lg-sat));  
          box-shadow: var(--lg-shadow), var(--lg-inner);  
          border-radius: var(--lg-radius);  
          transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);  
          background-clip: padding-box, border-box;  
        }  
        .lg-surface::after{  
          content:"";  
          position:absolute; inset:0; pointer-events:none; border-radius:inherit; z-index:-1;  
          background:  
            radial-gradient(ellipse 60% 30% at 20% 10%, var(--lg-highlight), transparent 60%),  
            radial-gradient(ellipse 40% 20% at 80% 80%, var(--lg-glow), transparent 70%);  
          opacity:.8;  
          transition: opacity .2s ease, transform .4s cubic-bezier(0.4, 0, 0.2, 1);  
        }  
        .lg-hover:hover{  
          transform: translateY(-1px);  
          box-shadow: 0 12px 32px rgba(0,0,0,.16), var(--lg-inner);  
        }  
        .lg-hover:hover::after{  
          /* Subtle one-shot light bend on hover */  
          animation: liquid-bend 0.6s ease-out;  
          opacity: 1;  
        }  
        @keyframes liquid-bend{  
          0%{ transform: scale(1) translateX(0); }  
          40%{ transform: scale(1.005) translateX(2px) skewX(-1deg); opacity: 1; }  
          100%{ transform: scale(1) translateX(4px) skewX(0deg); opacity: .9; }  
        }  
        .lg-press:active{ transform: var(--lg-press); }  
        
        /* NAVBAR */  
        .navbar{  
          border-bottom:1px solid var(--lg-stroke);  
          backdrop-filter: blur(6px) saturate(120%);  
          -webkit-backdrop-filter: blur(6px) saturate(120%);  
        }  
        .navbar.glass{  
          border-radius:0;  
          composes: lg-surface lg-hover from none;  
        }  
        
        /* Glass elements */  
        .card, .accordion-item, .tooltip-inner, .empty-state, .glass{  
          composes: lg-surface from none;  
          position: relative;  
        }  
        .card:hover{  
          box-shadow: 0 14px 36px rgba(0,0,0,.18), var(--lg-inner);  
        }  
        .card:active{ transform: var(--lg-press); }  
        .glass:hover::after{ animation: liquid-bend 0.6s ease-out; }  
        .accordion-button:not(.collapsed){  
          color:var(--spotify-green);  
          background: color-mix(in oklab, var(--spotify-green) 8%, transparent);  
          border-radius: calc(var(--lg-radius) - 1px);  
          composes: lg-hover from none;  
        }  
        .accordion-button{  
          border-radius: var(--lg-radius);  
        }  
        .accordion-body{  
          background: color-mix(in oklab, var(--lg-surface) 99%, transparent);  
          border-radius: 0 0 var(--lg-radius) var(--lg-radius);  
        }  
        
        /* Layout & basics */  
        .navbar-brand{letter-spacing:.2px;font-weight:700}  
        .brand-dot{ width:8px;height:8px;background:var(--spotify-green);border-radius:50%;margin-left:6px }  
        .container-narrow{ max-width:880px }  
        .avatar{ width:52px;height:52px;object-fit:cover;border-radius:50%;  
          box-shadow:0 0 0 1px var(--lg-stroke), 0 4px 12px rgba(0,0,0,.15);  
        }  
        .card-title{ font-weight:700 }  
        .muted{ color:var(--lg-text-muted) }  
        .section-heading{ font-weight:800; letter-spacing:.2px }  
        .track-link{ font-weight:600; color:inherit; text-decoration:none }  
        .track-link:hover{ text-decoration:underline }  
        .context-link{ color:var(--spotify-green)!important }  
        
        /* Chips & buttons */  
        .pill{  
          display:inline-flex; align-items:center; gap:.5rem;  
          padding:.35rem .7rem; border-radius:999px;  
          background:linear-gradient(180deg, color-mix(in oklab, var(--spotify-green) 12%, transparent), transparent);  
          border:1px solid color-mix(in oklab, var(--spotify-green) 30%, var(--lg-stroke));  
          color:var(--spotify-green); font-size:.85rem; font-weight:600;  
          composes: lg-surface from none;  
          --lg-blur: 4px;  
        }  
        .btn-success{  
          background:linear-gradient(180deg, color-mix(in oklab, var(--spotify-green) 85%, white), var(--spotify-green));  
          border:1px solid color-mix(in oklab, var(--spotify-green) 55%, white);  
          color:#000; /* Better contrast */  
          box-shadow:0 6px 20px rgba(29,185,84,.20), var(--lg-inner);  
          border-radius:999px;  
          composes: lg-hover lg-press from none;  
        }  
        .btn-success:hover{ filter:brightness(1.02) }  
        .btn-ghost{  
          background:linear-gradient(180deg, color-mix(in oklab, #ffffff 8%, transparent), transparent);  
          border:1px solid var(--lg-stroke);  
          color:inherit; border-radius:999px;  
          composes: lg-surface lg-hover from none;  
          --lg-blur: 4px;  
        }  
        .btn-ghost:hover{ border-color:var(--spotify-green); color:var(--spotify-green) }  
        
        /* Inputs */  
        .form-outline .form-control{  
          background: linear-gradient(180deg, color-mix(in oklab, var(--lg-surface) 95%, transparent), transparent);  
          border:1px solid var(--lg-stroke);  
          border-radius:12px; color:inherit;  
          composes: lg-surface from none;  
          --lg-blur: 4px;  
        }  
        .form-outline .form-control:focus{  
          border-color: color-mix(in oklab, var(--spotify-green) 40%, var(--lg-stroke));  
          box-shadow:0 0 0 .15rem color-mix(in oklab, var(--spotify-green) 12%, transparent);  
        }  
        .form-outline .form-control ~ .form-label{ color:var(--spotify-light) }  
        
        /* Tooltip & code */  
        .tooltip-inner{ padding:.5rem .75rem; color:inherit; }  
        .code-block{  
          background: var(--lg-highlight);  
          padding:.3rem .55rem; border-radius:.35rem;  
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;  
          font-size:.9rem;  
        }  
        html[data-mdb-theme='light'] .code-block{ background: rgba(0,0,0,.04); }  
        
        /* Empty state */  
        .empty-state{  
          border:1px dashed var(--lg-stroke);  
          border-radius:.75rem; padding:2rem; text-align:center;  
          composes: lg-surface from none;  
          --lg-blur: 4px;  
        }  
        
        /* Fallbacks */  
        @supports not (backdrop-filter: blur(1px)){  
          .lg-surface, .glass, .pill, .btn-ghost, .form-outline .form-control{  
            backdrop-filter:none; -webkit-backdrop-filter:none;  
            background: var(--lg-surface-solid);  
            border:1px solid var(--lg-stroke);  
            box-shadow: var(--lg-shadow);  
          }  
        }  
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg glass lg-surface lg-hover">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fab fa-spotify me-2" style="color: var(--spotify-green);"></i>
                Friend Activity
                <span class="brand-dot"></span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="pill d-none d-md-inline"><i class="fa-regular fa-bell"></i> Live feed</span>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" role="switch" id="theme-switch" />
                    <label class="form-check-label d-none d-sm-inline" for="theme-switch"><i class="fas fa-sun me-2"></i>/<i class="fas fa-moon ms-2"></i></label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container container-narrow mt-5 mb-5">
        <!-- Cookie Input Form & FAQ -->
        <div id="cookie-form-container" class="row justify-content-center">
            <div class="col-12">
                <div class="card glass lg-surface lg-hover">
                    <div class="card-body p-4 p-md-5">
                        <div class="d-flex align-items-start justify-content-between mb-3">
                            <div>
                                <h3 class="section-heading mb-2">View Friend Activity</h3>
                                <p class="muted mb-0">Provide your Spotify <code class="code-block">sp_dc</code> cookie to see what your friends are listening to.</p>
                            </div>
                            <i class="fab fa-spotify fa-2x" style="color: var(--spotify-green);" aria-hidden="true"></i>
                        </div>
                        <form id="cookie-form" class="mt-4">
                            <div class="form-outline mb-3" data-mdb-input-init>
                                <input type="password" id="sp_dc_cookie_input" class="form-control" autocomplete="off" />
                                <label class="form-label" for="sp_dc_cookie_input">sp_dc Cookie Value</label>
                            </div>
                            <div class="d-grid d-sm-flex gap-2">
                                <button type="submit" class="btn btn-success px-4 lg-hover lg-press" data-mdb-ripple-init>
                                    <i class="fa-solid fa-lock me-2"></i>Save and Fetch Activity
                                </button>
                            </div>
                        </form>

                        <!-- FAQ Accordion -->
                        <div class="accordion mt-4" id="faqAccordion">
                            <div class="accordion-item glass">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed glass lg-surface lg-hover" type="button" data-mdb-collapse-init data-mdb-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                        <i class="fas fa-question-circle me-2"></i> What is this?
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-mdb-parent="#faqAccordion">
                                    <div class="accordion-body glass lg-surface">
                                        This website shows the Friend Activity feed, a feature of the Spotify desktop app, in a clean, web-friendly view.
                                        <br><br>
                                        <strong>Requirements:</strong>
                                        <ul class="mb-0">
                                            <li>You must be following the friends you want to see.</li>
                                            <li>Your friends must have “Share my listening activity on Spotify” enabled.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item glass">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed glass lg-surface lg-hover" type="button" data-mdb-collapse-init data-mdb-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        <i class="fas fa-cookie-bite me-2"></i> What is <code class="code-block">sp_dc</code> and how do I get it?
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-mdb-parent="#faqAccordion">
                                    <div class="accordion-body glass lg-surface">
                                        The <code class="code-block">sp_dc</code> cookie is a long-term authentication token used to access your friend feed. It is only stored in your browser and never on our server.
                                        <hr class="my-3">
                                        <strong>Step 1:</strong> Log in to <a class="context-link" href="https://open.spotify.com" target="_blank">open.spotify.com</a> on desktop.
                                        <br><br>
                                        <strong>Step 2:</strong> Get the cookie using one of these methods:
                                        <p class="mt-3 mb-1"><strong>Method A: Developer Tools (Recommended)</strong></p>
                                        <ol class="mb-3">
                                            <li>Press <kbd>F12</kbd> or <kbd>Ctrl+Shift+I</kbd> / <kbd>Cmd+Opt+I</kbd>.</li>
                                            <li>Go to the <strong>Application</strong> or <strong>Storage</strong> tab.</li>
                                            <li>Open Cookies → <code class="code-block">https://open.spotify.com</code>.</li>
                                            <li>Find <code class="code-block">sp_dc</code> and copy its value.</li>
                                        </ol>
                                        <p class="mt-3 mb-1"><strong>Method B: Cookie Extension</strong></p>
                                        <ol class="mb-0">
                                            <li>Install a trusted cookie editor extension.</li>
                                            <li>With <code class="code-block">open.spotify.com</code> active, open the extension.</li>
                                            <li>Copy the value of <code class="code-block">sp_dc</code>.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End FAQ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Display Area -->
        <div id="activity-container" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button id="clear-cookie-btn" class="btn btn-sm btn-ghost lg-hover" data-mdb-ripple-init><i class="fas fa-trash me-2"></i>Clear Cookie</button>
                <div class="d-flex gap-2">
                    <button id="refresh-btn" class="btn btn-sm btn-success lg-hover lg-press" data-mdb-ripple-init><i class="fas fa-rotate me-2"></i>Refresh</button>
                </div>
            </div>

            <div id="loading-spinner" class="text-center my-5">
                <div class="spinner-border" style="color: var(--spotify-green);" role="status"><span class="visually-hidden">Loading...</span></div>
                <p class="mt-2 muted">Fetching activity...</p>
            </div>

            <div id="error-message" class="alert alert-danger d-none"></div>

            <div id="activity-list" class="row gy-4">
                <!-- Cards injected here -->
            </div>

            <div id="empty" class="empty-state d-none mt-4 glass lg-surface">
                <i class="fa-regular fa-face-smile-beam fa-2x mb-2" style="color: var(--spotify-green);"></i>
                <p class="mb-0">No friend activity found.</p>
            </div>
        </div>
    </div>

    <!-- MDB -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.3.2/mdb.umd.min.js"></script>
    
    <script>
        // DOM Elements
        const themeSwitch = document.getElementById('theme-switch');
        const cookieFormContainer = document.getElementById('cookie-form-container');
        const activityContainer = document.getElementById('activity-container');
        const cookieForm = document.getElementById('cookie-form');
        const cookieInput = document.getElementById('sp_dc_cookie_input');
        const clearCookieBtn = document.getElementById('clear-cookie-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageDiv = document.getElementById('error-message');
        const activityList = document.getElementById('activity-list');
        const COOKIE_KEY = 'spotify_sp_dc_cookie';

        // THEME MANAGEMENT
        const getPreferredTheme = () => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-mdb-theme', theme);
            localStorage.setItem('theme', theme);
            themeSwitch.checked = (theme === 'dark');
        };
        themeSwitch.addEventListener('change', () => setTheme(themeSwitch.checked ? 'dark' : 'light'));
        setTheme(getPreferredTheme());

        // TIME FORMATTING
        const timeAgo = (timestamp) => {
            if (!timestamp) return 'N/A';
            const now = new Date();
            const past = new Date(timestamp);
            const seconds = Math.floor((now - past) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "Just now";
        };

        // API & RENDERING LOGIC
        async function fetchActivity() {
            const storedCookie = localStorage.getItem(COOKIE_KEY);
            if (!storedCookie) {
                showView('form');
                return;
            }
            showView('activity');
            setLoading(true);
            setError(null);
            activityList.innerHTML = '';
            try {
                const response = await fetch('/api/activity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sp_dc_cookie: storedCookie })
                });
                const data = await response.json();
                if (!response.ok) {
                    localStorage.removeItem(COOKIE_KEY);
                    throw new Error(data.error || 'An unknown error occurred.');
                }
                renderActivity(data.friends);
            } catch (error) {
                setError(error.message);
                showView('form');
            } finally {
                setLoading(false);
            }
        }

        function renderActivity(friends) {
            const empty = document.getElementById('empty');
            if (!friends || friends.length === 0) {
                activityList.innerHTML = '';
                empty.classList.remove('d-none');
                return;
            }
            empty.classList.add('d-none');

            const html = friends.map(friend => {
                const fullDate = friend.timestamp ? new Date(friend.timestamp).toLocaleString() : 'N/A';
                return `
                <div class="col-lg-6 col-xl-6">
                    <div class="card glass lg-surface lg-hover h-100">
                        <div class="card-body d-flex p-3">
                            <a href="${friend.user_url}" target="_blank" aria-label="${friend.user_name}">
                                <img src="${friend.user_image_url}" class="rounded-circle avatar me-3" alt="${friend.user_name}" />
                            </a>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <a href="${friend.user_url}" target="_blank" class="text-body text-decoration-none"><strong>${friend.user_name}</strong></a>
                                    <small class="text-muted" data-mdb-toggle="tooltip" title="${fullDate}">${timeAgo(friend.timestamp)}</small>
                                </div>
                                <p class="mb-1">
                                    <a href="${friend.track_url}" target="_blank" class="track-link">${friend.track_name}</a>
                                    <span class="text-muted">• ${friend.artist_name}</span>
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-play-circle me-1"></i>
                                    From: <a href="${friend.context_url}" target="_blank" class="context-link">${friend.context_name}</a>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            activityList.innerHTML = html;
            document.querySelectorAll('[data-mdb-toggle="tooltip"]').forEach(el => new mdb.Tooltip(el));
        }

        // UI STATE
        const showView = (view) => {
            cookieFormContainer.classList.toggle('d-none', view !== 'form');
            activityContainer.classList.toggle('d-none', view !== 'activity');
        };
        const setLoading = (isLoading) => loadingSpinner.classList.toggle('d-none', !isLoading);
        const setError = (message) => {
            errorMessageDiv.textContent = message ? `Error: ${message}` : '';
            errorMessageDiv.classList.toggle('d-none', !message);
        };

        // EVENT LISTENERS
        cookieForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const cookieValue = cookieInput.value.trim();
            if (cookieValue) {
                localStorage.setItem(COOKIE_KEY, cookieValue);
                cookieInput.value = '';
                fetchActivity();
            }
        });
        clearCookieBtn.addEventListener('click', () => {
            localStorage.removeItem(COOKIE_KEY);
            showView('form');
            setError(null);
        });
        refreshBtn.addEventListener('click', fetchActivity);
        
        // INITIAL LOAD
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem(COOKIE_KEY)) {
                fetchActivity();
            } else {
                showView('form');
            }
            document.querySelectorAll('[data-mdb-input-init]').forEach((input) => { new mdb.Input(input).init(); });
        });
    </script>
</body>
</html>
